___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "trbo",
  "categories": [
    "PERSONALIZATION"
  ],
  "brand": {
    "displayName": "Norman Höhne",
    "id": "github.com_NormanHoehne",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALUAAAC1CAYAAAAZU76pAAAEs2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS41LjAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgeG1sbnM6ZXhpZj0iaHR0cDovL25zLmFkb2JlLmNvbS9leGlmLzEuMC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgZXhpZjpQaXhlbFhEaW1lbnNpb249IjE4MSIKICAgZXhpZjpQaXhlbFlEaW1lbnNpb249IjE4MSIKICAgZXhpZjpDb2xvclNwYWNlPSIxIgogICB0aWZmOkltYWdlV2lkdGg9IjE4MSIKICAgdGlmZjpJbWFnZUxlbmd0aD0iMTgxIgogICB0aWZmOlJlc29sdXRpb25Vbml0PSIyIgogICB0aWZmOlhSZXNvbHV0aW9uPSI3Mi4wIgogICB0aWZmOllSZXNvbHV0aW9uPSI3Mi4wIgogICBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIgogICBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiCiAgIHhtcDpNb2RpZnlEYXRlPSIyMDIx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4NwsTXquXTPaLPMl8uUkJqK6eg3eAtxd075j2wCcmaXJ34zb/Rj4fQ35qcMm4BNZmvy5X8IRgGJs3RLyPskTTS0lddGN9UKam2KrqtXAqVmaZNYNi3M8j4Z6Xg5gHZBmaXJfmcTbG9CLivdJtP9LHKuWpd1GFX2RPwjcVdcxBrCFfG3IY7I0sa7StV1RoJ1A/3btYdgKXAscnaXJP8tutMs0Y8XYvC+Tr9FX16L2sazM0sTy5rGy4u3eUppZ4rqXV4BbgeuLB9ooisEiFwJfxTYfdx02ArcB12ZpYq5edp07r3hVvZi8D8ZC8j6uC7DN1Vy3u7I0WdzkAZ0PpwEnk/f3Xlj8bVm5y+Il8qrByuLvh8hfrJRdHtmsCO7TyUvvRez47i1ra1q8RH5+o38eAu7O0uS1qju0TAg5esLzyN8iVX2FG9OaLE2GXh90PiTkP/iqr9fHe5X8LtTULFh9OR/mki//FqvT1kbgiT7DzUREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREREpIz/A6LJV5urrNGYAAAAAElFTkSuQmCC"
  },
  "description": "This is an unofficial Google Tag Manager custom template for the trbo personalization platform. It allows tracking of all important data points along the on-site customer journey. In order to work, at least one tag in \"Plugin code\" mode must be integrated on every single page.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "tagMode",
    "displayName": "Tag Mode",
    "radioItems": [
      {
        "value": "plugin",
        "displayValue": "Plugin Code",
        "subParams": [
          {
            "type": "TEXT",
            "name": "trboPluginCode",
            "displayName": "Plugin Code",
            "simpleValueType": true,
            "valueHint": "trbo_xxxxx_xxxxx",
            "help": "The plugin code is a synonym for the filename of the customer-individual JavaScript file (whose extension is \u0027.js\u0027) of trbo. This must load on each page. Structure of the plugin code: \u003cstrong\u003etrbo_shopID_individual Hash\u003c/strong\u003e. The Plugin Code tag should be fired after every other trbo tag (except the \u0027basket\u0027 event, since it requires user interaction first).",
            "alwaysInSummary": false,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ]
      },
      {
        "value": "event",
        "displayValue": "Event Tracking",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "enhancedEcommerce",
            "checkboxText": "Enhanced Ecommerce dataLayer Integration",
            "simpleValueType": true,
            "help": "If you check this, then the trbo Tracking pixel will populate \u003cstrong\u003eEvent Name\u003c/strong\u003e and \u003cstrong\u003eObject Properties\u003c/strong\u003e automatically from the last \u003ca href\u003d\"https://developers.google.com/tag-manager/enhanced-ecommerce\"\u003eecommerce\u003c/a\u003e object pushed into the dataLayer array."
          },
          {
            "type": "RADIO",
            "name": "eventName",
            "displayName": "Event Name",
            "radioItems": [
              {
                "value": "standard",
                "displayValue": "Standard",
                "subParams": [
                  {
                    "type": "SELECT",
                    "name": "standardEventName",
                    "selectItems": [
                      {
                        "displayValue": "Page View",
                        "value": "page"
                      },
                      {
                        "displayValue": "Product View",
                        "value": "productView"
                      },
                      {
                        "displayValue": "Basket",
                        "value": "basket"
                      },
                      {
                        "displayValue": "Current Basket",
                        "value": "currentBasket"
                      },
                      {
                        "displayValue": "Sale",
                        "value": "sale"
                      },
                      {
                        "displayValue": "Lead",
                        "value": "lead"
                      }
                    ],
                    "simpleValueType": true,
                    "displayName": "Event",
                    "defaultValue": "",
                    "alwaysInSummary": true,
                    "enablingConditions": [
                      {
                        "paramName": "enhancedEcommerce",
                        "paramValue": false,
                        "type": "EQUALS"
                      }
                    ]
                  }
                ]
              },
              {
                "value": "custom",
                "displayValue": "Custom",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "customEventName",
                    "displayName": "",
                    "simpleValueType": true
                  }
                ]
              },
              {
                "value": "variable",
                "displayValue": "Variable",
                "subParams": [
                  {
                    "type": "SELECT",
                    "name": "variableEventName",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "enhancedEcommerce",
                "paramValue": true,
                "type": "NOT_EQUALS"
              }
            ]
          },
          {
            "type": "RADIO",
            "name": "eecEventName",
            "displayName": "Event Name",
            "radioItems": [
              {
                "value": "eec",
                "displayValue": "Set automatically from dataLayer"
              }
            ],
            "simpleValueType": true,
            "help": "The Enhanced Ecommerce integration populates the Event Name automatically depending on what type of \u003cstrong\u003eecommerce\u003c/strong\u003e object was last pushed into dataLayer (\"detail\" -\u003e \"productView\", \"add\" -\u003e \"basket\", \"purchase\" -\u003e \"sale\", ...).",
            "enablingConditions": [
              {
                "paramName": "enhancedEcommerce",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          },
          {
            "displayName": "Object Properties",
            "name": "objectPropertiesGroup",
            "groupStyle": "ZIPPY_CLOSED",
            "type": "GROUP",
            "subParams": [
              {
                "type": "LABEL",
                "name": "enhancedEcommerceObject",
                "displayName": "\u003cstrong\u003eWarning!\u003c/strong\u003e Object properties are populated automatically based on the most recent \u003cstrong\u003eecommerce\u003c/strong\u003e object pushed into dataLayer. If you add properties here that are already set by the integration (value, currency, order_id, etc.), then the properties you add here will override those set automatically by the integration!",
                "enablingConditions": [
                  {
                    "paramName": "enhancedEcommerce",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ]
              },
              {
                "type": "SELECT",
                "name": "objectPropertiesFromVariable",
                "displayName": "Load Properties From Variable",
                "macrosInSelect": true,
                "selectItems": [
                  {
                    "value": false,
                    "displayValue": "False"
                  }
                ],
                "simpleValueType": true,
                "help": "You can use a variable that returns a JavaScript object with the properties you want to use. This object will be merged with any additional properties you add via the table below. Any conflicts will be resolved in favor of the properties you add to the table."
              },
              {
                "name": "objectPropertyList",
                "simpleTableColumns": [
                  {
                    "valueValidators": [],
                    "defaultValue": "",
                    "displayName": "Property Name",
                    "name": "name",
                    "isUnique": true,
                    "type": "TEXT"
                  },
                  {
                    "defaultValue": "",
                    "displayName": "Property Value",
                    "name": "value",
                    "type": "TEXT"
                  }
                ],
                "type": "SIMPLE_TABLE",
                "newRowButtonText": "Add property"
              }
            ]
          }
        ]
      }
    ],
    "simpleValueType": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require the necessary APIs
const copyFromDataLayer = require('copyFromDataLayer');
const createQueue = require('createQueue');
const ecommerce = copyFromDataLayer('ecommerce', 1);
const encodeUriComponent = require('encodeUriComponent');
const getType = require('getType');
const injectScript = require('injectScript');
const log = require('logToConsole');
const makeNumber = require('makeNumber');
const makeTableMap = require('makeTableMap');
const math = require('Math');

// Helper methods
const fail = msg => {
  log(msg);
  data.gtmOnFailure();
};

const mergeObj = (obj, obj2) => {
  for (let key in obj2) {
    if (obj2.hasOwnProperty(key)) {
      obj[key] = obj2[key];
    }
  }
  return obj;
};

const parseEecObj = prod => {
  return {
    product_id: prod.id,
    name: prod.name,
    price: math.round(makeNumber(prod.price || 0) * 100) / 100,
    quantity: prod.quantity || 1, // if a product was submitted without a quantity here, we assume that it is at least 1
  };
};

const _trboqPush = createQueue('_trboq');
const push = function(params) {
  _trboqPush(params);
  log('trbo Push:', params);
};

if(data.tagMode === 'event') {
  // Initialize EEC integration
  let eventName, action, eecObjectProps;
  if (data.enhancedEcommerce) {
    if (!ecommerce) return fail('trbo: No valid "ecommerce" object found in dataLayer');
    if (ecommerce.detail) { eventName = 'productView'; action = 'detail'; }
    else if (ecommerce.add) { eventName = 'basket'; action = 'add'; }
    else if (ecommerce.purchase) { eventName = 'sale'; action = 'purchase'; }
    else return fail('trbo: Most recently pushed "ecommerce" object must be one of types "detail", "add", "checkout" or "purchase".');

    if (!ecommerce[action].products || getType(ecommerce[action].products) !== 'array') return fail('trbo: Most recently pushed "ecommerce" object did not have a valid "products" array.');

    eecObjectProps = {
    // try to get the cart's value from the 'revenue' key of the EEC object; otherwise sum up the values of all products
      value: ecommerce[action].actionField && ecommerce[action].actionField.revenue ? ecommerce[action].actionField.revenue : ecommerce[action].products.reduce((acc, cur) => {
        const curVal = math.round(makeNumber(cur.price || 0) * (cur.quantity || 1) * 100) / 100;
        return acc + curVal;
      }, 0.0),
      currency: ecommerce.currencyCode || 'EUR',
      products: ecommerce[action].products.map(parseEecObj)
    };

    if(eventName === 'sale') {
      if (typeof ecommerce[action].actionField.coupon !== 'undefined') eecObjectProps.coupon_code = ecommerce[action].actionField.coupon;
      if (typeof ecommerce[action].actionField.id !== 'undefined' ) eecObjectProps.order_id = ecommerce[action].actionField.id;
    }
  }

  // Build the _trboq dataLayer arguments
  const objectProps = data.objectPropertyList && data.objectPropertyList.length ? makeTableMap(data.objectPropertyList, 'name', 'value') : {};
  const objectPropsFromVar = getType(data.objectPropertiesFromVariable) === 'object' ? data.objectPropertiesFromVariable : {};
  const mergedObjectProps = mergeObj(objectPropsFromVar, objectProps);
  const finalObjectProps = mergeObj(eecObjectProps || {}, mergedObjectProps);
  eventName = eventName || (data.eventName === 'custom' ? data.customEventName : (data.eventName === 'variable' ? data.variableEventName : data.standardEventName));

  // Finally push the event into the _trboq dataLayer
  push([eventName, finalObjectProps]);

  // Call data.gtmOnSuccess when the tag is finished.
  data.gtmOnSuccess();

} else {
  injectScript('https://static.trbo.com/plugin/' + encodeUriComponent(data.trboPluginCode) + ".js", data.gtmOnSuccess, data.gtmOnFailure, 'trboPluginCode');
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_trboq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ecommerce"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://static.trbo.com/plugin/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 4.1.2022, 21:05:07


